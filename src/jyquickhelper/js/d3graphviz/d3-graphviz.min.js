!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("d3-selection"),require("d3-dispatch"),require("d3-transition"),require("d3-timer"),require("d3-zoom"),require("d3-interpolate"),require("viz.js"),require("d3-format")):"function"==typeof define&&define.amd?define(["exports","d3-selection","d3-dispatch","d3-transition","d3-timer","d3-zoom","d3-interpolate","viz.js","d3-format"],e):e(t.d3=t.d3||{},t.d3,t.d3,t.d3,t.d3,t.d3,t.d3,t.Viz,t.d3)}(this,function(t,e,n,i,r,a,o,s,l){"use strict";function h(){var t=this._selection,n=e.select(t.node().querySelector("svg"));if(0==n.size())return this;this._zoomSelection=n;var i=a.zoom().scaleExtent([.1,10]).interpolate(e.interpolate).on("zoom",function(){r.attr("transform",e.event.transform)});this._zoomBehavior=i;var r=e.select(n.node().querySelector("g"));return n.call(i),this._active||u.call(this,r),this._originalTransform=a.zoomTransform(n.node()),this}function c(t){var e=this._translation,n=t.datum().translation,i=n.x-e.x,r=n.y-e.y;return a.zoomTransform(this._zoomSelection.node()).translate(i,r)}function u(t){this._zoomBehavior.transform(this._zoomSelection,c.call(this,t)),this._translation=t.datum().translation}function d(t){var e={},n=t.node().nodeName;e.tag=n,e.attributes={};var i=t.node().attributes;if(i)for(var r=0;r<i.length;r++){var a=i[r],o=a.name,s=a.value;e.attributes[o]=s}if(t.node().transform){var l=function(t){var e=t.node().transform;if(e&&0!=e.baseVal.length){var n=e.baseVal.consolidate().matrix;return{x:n.e,y:n.f}}return{x:0,y:0}}(t);0==l.x&&0==l.y||(e.translation=l)}if("ellipse"==n&&e.attributes.cx&&(e.center={x:e.attributes.cx,y:e.attributes.cy}),"polygon"==n&&e.attributes.points){var h=t.attr("points").split(" "),c=h.map(function(t){return t.split(",")[0]}),u=h.map(function(t){return t.split(",")[1]}),d=Math.min.apply(null,c),f=Math.max.apply(null,c),p=Math.min.apply(null,u),g=Math.max.apply(null,u),v={x:d,y:p,width:f-d,height:g-p};e.bbox=v,e.center={x:(d+f)/2,y:(p+g)/2}}return"path"==n&&(t.node().getTotalLength?e.totalLength=t.node().getTotalLength():e.totalLength=100),"#text"==n?e.text=t.text():"#comment"==n&&(e.comment=t.text()),e}function f(t){return"#text"==t.tag?document.createTextNode(""):"#comment"==t.tag?document.createComment(t.comment):document.createElementNS("http://www.w3.org/2000/svg",t.tag)}function p(t){var n=f(t),i=e.select(n),r=t.attributes;if(r)for(var a of Object.keys(r)){var o=r[a];i.attr(a,o)}return n}function g(t,n){var i=e.select(t.node().parentNode),r=p(n),a=i.insert(function(){return r},function(){return t.node()});return t.remove(),a}function v(t){return Object.assign({},t)}function y(t,e){return function(){var n=t.map(function(t){return o.interpolate([t[0][0],t[0][1]],[t[1][0],t[1][1]])});return function(t){return t<1?"M"+n.map(function(e){return e(t)}).join("L"):e}}}function m(t){return"edge"==t.attributes.class||"a"==t.tag&&"g"==t.parent.tag&&"edge"==t.parent.parent.attributes.class}function _(t){return t.parent&&m(t.parent)}function x(t){function n(t){var h=t.selectAll(function(){return t.node().childNodes}),x=(h=h.data(function(t){return t.children},function(t){return t.key})).enter().append(function(t){var e=f(t);return"#text"==t.tag&&r&&(e.nodeValue=t.text),e});if(r||l&&m(t.datum())){x.filter(function(t){return"#"==t.tag[0]?null:this}).each(function(t){var n=e.select(this);for(var i of Object.keys(t.attributes)){var r=t.attributes[i];n.attr(i,r)}}).filter(function(t){return"svg"==t.tag||"g"==t.tag?null:this}).style("opacity",0)}var w=h.exit();p&&w.each(p),i&&(w=w.transition(i),r&&w.filter(function(t){return"#"==t.tag[0]?null:this}).style("opacity",0)),w=w.remove(),h=x.merge(h),p&&h.each(p),h.each(function(h){var f=e.select(this),p=h.tag,m=h.attributes,x=!1;if(o&&i&&h.alternativeOld){if("polygon"==this.nodeName||"ellipse"==this.nodeName){x=!0;var w=d(f);if("polygon"==this.nodeName&&"polygon"==p){var b=w.attributes.points;if(null==b)x=!1;else if(!s){var E=b.split(" ").length;(R=h.attributes.points).split(" ").length==E&&(x=!1)}}else"ellipse"==this.nodeName&&"ellipse"==p&&(x=!1)}if(x){var k=h.alternativeOld,z=g(f,k);z.data([h],function(){return h.key});var M=h.alternativeNew;f=z,p="path",m=M.attributes}}var P=f;i&&(P=P.transition(i),r&&P.filter(function(t){return"#"==t.tag[0]?null:this}).style("opacity",1),P.filter(function(t){return"#"==t.tag[0]?null:this}).on("end",function(){e.select(this).attr("style",null)}));if(l&&"path"==p&&h.offset){var S=h.totalLength;f.attr("stroke-dasharray",S+" "+S).attr("stroke-dashoffset",S).attr("transform","translate("+h.offset.x+","+h.offset.y+")"),P.attr("stroke-dashoffset",0).attr("transform","translate(0,0)").on("start",function(){e.select(this).style("opacity",null)}).on("end",function(){e.select(this).attr("stroke-dashoffset",null).attr("stroke-dasharray",null).attr("transform",null)})}if(l&&"polygon"==p&&_(h)&&h.offset){var L=e.select(t.node().querySelector("path"));if(L.node().getPointAtLength)var q=L.node().getPointAtLength(0),j=L.node().getPointAtLength(h.totalLength),T=L.node().getPointAtLength(h.totalLength-1),N=180*Math.atan2(j.y-T.y,j.x-T.x)/Math.PI;else q={x:0,y:0},j={x:100,y:100},N=0;var O=q.x-j.x+h.offset.x,A=q.y-j.y+h.offset.y;f.attr("transform","translate("+O+","+A+")"),P.attrTween("transform",function(){return function(t){if(L.node().getPointAtLength)var e=L.node().getPointAtLength(h.totalLength*t),n=L.node().getPointAtLength(h.totalLength*t+1),i=180*Math.atan2(n.y-e.y,n.x-e.x)/Math.PI-N;else e={x:100*t,y:100*t},i=0;return O=e.x-j.x+h.offset.x*(1-t),A=e.y-j.y+h.offset.y*(1-t),"translate("+O+","+A+") rotate("+i+" "+j.x+" "+j.y+")"}}).on("start",function(){e.select(this).style("opacity",null)}).on("end",function(){e.select(this).attr("transform",null)})}var B=a&&i&&"path"==p&&null!=f.attr("d");for(var D of Object.keys(m)){var U=m[D];if(B&&"d"==D){var R;(R=(h.alternativeOld||h).points)&&P.attrTween("d",y(R,U))}else"transform"==D&&h.translation&&P.on("start",function(){v._zoomBehavior&&P.attr(D,c.call(v,f).toString())}).on("end",function(){v._zoomBehavior&&u.call(v,f)}),P.attr(D,U)}x&&P.on("end",function(t,n,i){if(this.nodeName!=t.tag){g(z=e.select(this),t).data([t],function(){return t.key})}}),h.text&&P.text(h.text),n(f)})}var i=this._transition,r=this._fade&&null!=i,a=this._tweenPaths,o=this._tweenShapes,s=this._convertEqualSidedPolygons,l=(this._tweenPrecision,this._growEnteringEdges&&null!=i),p=this._attributer,v=this,x=this._selection;if(null!=i){var w=this._jobs;if(v._active)return w.push(null),this;x.transition(i).transition().duration(0).on("end",function(){v._active=!1,0!=w.length&&(w.shift(),v.render())}),this._active=!0}null!=i&&x.transition(i).on("start",function(){v._dispatch.call("transitionStart",v)}).on("end",function(){v._dispatch.call("transitionEnd",v)}).transition().duration(0).on("start",function(){v._dispatch.call("restoreEnd",v),v._dispatch.call("end",v),t&&t.call(v)});var b=this._data;return x.datum({attributes:{},children:[b]}),n(x),this._zoom&&!this._zoomBehavior&&h.call(this),v._dispatch.call("renderEnd",v),null==i&&(this._dispatch.call("end",this),t&&t.call(this)),this}function w(t,e){if("polygon"==t.tag){(S=v(t)).tag="path";var n=v(u=t.attributes);if(null!=u.points){var i=u.points;if("polygon"==e.tag){(d=t.bbox).cx=d.x+d.width/2,d.cy=d.y+d.height/2;for(var r=u.points.split(" "),a=r.map(function(t){var e=t.split(",");return[e[0]-d.cx,e[1]-d.cy]}),o=a[a.length-1][0],s=a[a.length-1][1],l=0;l<a.length;l++,o=m,s=_){var h=(m=a[l][0])-o;if(0!=(k=(_=a[l][1])-s)){if(0<=(x=o-s*h/k)&&x<1/0&&(o<=x&&x<=m||m<=x&&x<=o))break}}var c=[[d.cx+x,d.cy+0].join(",")];i=(c=(c=c.concat(r.slice(l))).concat(r.slice(0,l))).join(" ")}n.d="M"+i+"z",delete n.points}S.attributes=n}else if("ellipse"==t.tag){(S=v(t)).tag="path";var u;n=v(u=t.attributes);if(null!=u.cx){var d,f=u.cx,p=u.cy,g=u.rx,y=u.ry;(d=e.bbox).cx=d.x+d.width/2,d.cy=d.y+d.height/2;var m,_,x,w=e.attributes.points.split(" ")[0].split(","),b=w[0],E=w[1],k=(h=b-d.cx,E-d.cy),z=Math.sqrt(Math.pow(h,2)+Math.pow(k,2)),M=h/z,P=-k/z;h=(x=g*-M)-(m=g*M),k=-y*-P-(_=-y*P);n.d="M "+f+" "+p+" m "+m+","+_+" a "+g+","+y+" 0 1,0 "+h+","+k+" a "+g+","+y+" 0 1,0 "+-h+","+-k+"z",delete n.cx,delete n.cy,delete n.rx,delete n.ry}S.attributes=n}else var S=t;return S}function b(t){if("undefined"!=typeof Worker){var i=new Blob(['\n            onmessage = function(event) {\n                if (event.data.vizURL) {\n                    importScripts(event.data.vizURL);\n                }\n                var svg = Viz(event.data.dot, event.data.options);\n\n                if (svg) {\n                    postMessage({\n                        type: "done",\n                        svg: svg,\n                    });\n                } else {\n                    postMessage({\n                        type: "skip",\n                    });\n                }\n            }\n        ']),r=window.URL.createObjectURL(i);this._worker=new Worker(r)}this._selection=t,this._active=!1,this._busy=!1,this._jobs=[],this._queue=[],this._keyModes=new Set(["title","id","tag-index","index"]),this._engine="dot",this._images=[],this._totalMemory=void 0,this._keyMode="title",this._fade=!0,this._tweenPaths=!0,this._tweenShapes=!0,this._convertEqualSidedPolygons=!0,this._tweenPrecision=1,this._growEnteringEdges=!0,this._translation={x:0,y:0},this._zoom=!0,this._eventTypes=["initEnd","start","layoutStart","layoutEnd","dataExtractEnd","dataProcessEnd","renderStart","renderEnd","transitionStart","transitionEnd","restoreEnd","end"],this._dispatch=n.dispatch(...this._eventTypes),function(){if(null==this._worker)s(""),this._dispatch.call("initEnd",this);else{var t=e.selectAll("script").filter(function(){return"javascript/worker"==e.select(this).attr("type")}).attr("src"),n=this;this._worker.onmessage=function(t){n._dispatch.call("initEnd",this)},t.match(/^https?:\/\/|^\/\//i)||(t=document.location.protocol+"//"+document.location.host+"/"+t),this._worker.postMessage({dot:"",vizURL:t})}}.call(this)}function E(t){return new b(e.select(t))}b.prototype=E.prototype={constructor:b,engine:function(t){if(t!=this._engine&&null!=this._data)throw Error("Too late to change engine");return this._engine=t,this},addImage:function(t,e,n){return this._images.push({path:t,width:e,height:n}),this},totalMemory:function(t){return this._totalMemory=t,this},keyMode:function(t){if(!this._keyModes.has(t))throw Error("Illegal keyMode: "+t);if(t!=this._keyMode&&null!=this._data)throw Error("Too late to change keyMode");return this._keyMode=t,this},fade:function(t){return this._fade=t,this},tweenPaths:function(t){return this._tweenPaths=t,this},tweenShapes:function(t){return this._tweenShapes=t,t&&(this._tweenPaths=!0),this},convertEqualSidedPolygons:function(t){return this._convertEqualSidedPolygons=t,this},tweenPrecision:function(t){return this._tweenPrecision=t,this},growEnteringEdges:function(t){return this._growEnteringEdges=t,this},zoom:function(t){return this._zoom=t,this._zoom&&!this._zoomBehavior&&h.call(this),this},resetZoom:function(t){var e=this._zoomSelection;return t&&(e=e.transition(t)),e.call(this._zoomBehavior.transform,this._originalTransform),this},render:function(t){return this._busy?(this._queue.push(this.render),this):(this._dispatch.call("renderStart",this),this._transitionFactory?r.timeout(function(){this._transition=i.transition(this._transitionFactory()),x.call(this,t)}.bind(this),0):x.call(this,t),this)},dot:function(t,n){function i(t,n=0,r){var a=d(t);a.parent=r,a.children=[];var o=a.tag;"#text"==o?a.text=t.text():"#comment"==o&&(a.comment=t.text());var s=e.selectAll(t.node().childNodes);"index"==f?a.key=n:"#"!=o[0]&&("id"==f?a.key=t.attr("id"):"title"==f&&(t.select("title"),t.select("title").empty()||(a.key=t.select("title").text()))),null==a.key&&(v&&("ellipse"!=o&&"polygon"!=o||(o="path")),a.key=o+"-"+n);var l=(r?r.id+".":"")+a.key;a.id=l,x[l]=a;var h=b[l];if(v&&l in b&&("polygon"!=h.tag&&"ellipse"!=h.tag||h.tag==a.tag&&"polygon"!=a.tag||(a.alternativeOld=w(h,a),a.alternativeNew=w(a,h))),g&&h&&("path"==h.tag||a.alternativeOld&&"path"==a.alternativeOld.tag)){var c=(a.alternativeNew||a).attributes.d;if(a.alternativeOld)var u=p(a.alternativeOld);else u=p(h);(a.alternativeOld||(a.alternativeOld={})).points=function(t,e,n){var i=t,r=i.cloneNode();if(t.getTotalLength)var a=i.getTotalLength(),o=(r.setAttribute("d",e),r).getTotalLength();else a=100,o=50;for(var s=[0],l=0,h=n/Math.max(a,o);(l+=h)<1;)s.push(l);return s.push(1),s.map(function(e){if(t.getPointAtLength)var n=i.getPointAtLength(e*a),s=r.getPointAtLength(e*o);else n={x:e*a,y:e*a},s={x:e*o,y:e*o};return[[n.x,n.y],[s.x,s.y]]})}(u,c,y)}var m={};return s.each(function(){if(null!==this){var t=this.nodeName;"ellipse"!=t&&"polygon"!=t||(t="path"),null==m[t]&&(m[t]=0);var n=m[t]++,r=i(e.select(this),n,a);r&&a.children.push(r)}}),a}function r(t){var e=t.id,n=t.tag,i=b[e];if(m&&t.parent&&"node"==t.parent.attributes.class&&"title"==n){var a=(s=t.children[0]).text;E[a]=t.parent}if(m&&!i&&t.parent&&_(t)&&("path"==n||"polygon"==n)){if("polygon"==n){var o=t.parent.children.find(function(t){return"path"==t.tag});t.totalLength=o.totalLength}var s,l=(s=function(t){return function(t){return"edge"==t.parent.attributes.class?t.parent:t.parent.parent.parent}(t).children.find(function(t){return"title"==t.tag})}(t).children[0]).text.split("->");2!=l.length&&(l=s.text.split("--"));var h=l[0],c=E[h],u=k[h];if(u){if(!c)return;"g"==c.children[3].tag&&"a"==c.children[3].children[0].tag&&(c=c.children[3].children[0]),"g"==u.children[3].tag&&"a"==u.children[3].children[0].tag&&(u=u.children[3].children[0]);for(var d=c.children,f=0;f<d.length;f++)if("polygon"==d[f].tag||"ellipse"==d[f].tag){var p=d[f];break}if(void 0===p)throw Error("Unsupported start shape of node "+h+".\nPlease file an issue at https://github.com/magjac/d3-graphviz/issues");var g=u.children;for(f=0;f<g.length;f++)if("polygon"==g[f].tag||"ellipse"==g[f].tag){var v=g[f];break}if(void 0===v)throw Error("Unsupported previuous start shape of node "+h+".\nPlease file an issue at https://github.com/magjac/d3-graphviz/issues");t.offset={x:v.center.x-p.center.x,y:v.center.y-p.center.y}}}return t.children.forEach(function(t){r(t)}),t}function a(t){this._dispatch.call("layoutEnd",this);var a=e.selection().append("div").attr("display","none");a.html(t);var o=i(a.select("svg"));this._dispatch.call("dataExtractEnd",this),o=r(o),this._data=o,this._dictionary=x,this._nodeDictionary=E,a.remove(),this._extractData=i,this._busy=!1,this._dispatch.call("dataProcessEnd",this),n&&n.call(this),this._queue.length>0&&this._queue.shift().call(this)}var o=this,l=this._worker,h=this._engine,c=this._images,u=this._totalMemory,f=this._keyMode,g=this._tweenPaths,v=this._tweenShapes,y=this._tweenPrecision,m=this._growEnteringEdges,x={},b=this._dictionary||{},E={},k=this._nodeDictionary||{};this._dispatch.call("start",this),this._busy=!0,this._dispatch.call("layoutStart",this);var z={format:"svg",engine:h,images:c,totalMemory:u};return this._worker?(l.postMessage({dot:t,options:z}),l.onmessage=function(t){switch(t.data.type){case"done":return a.call(o,t.data.svg)}}):a.call(this,s(t,z)),this},renderDot:function(t,e){var n=this;return this.dot(t,function(){n.render(e)}),this},transition:function(t){return t instanceof Function?this._transitionFactory=t:this._transition=i.transition(t),this},attributer:function(t){return this._attributer=t,this},on:function(t,e){return this._dispatch.on(t,e),this},logEvents:function(t){var e=Date.now(),n={},i=this._eventTypes,r=Math.max(...i.map(t=>t.length));for(let h in i){let c=i[h];n[c]=[];var a,o,s=this;this.on(c+".log",t?function(){var t=Date.now(),i=n[c].length;n[c].push(t);var u="";if(u+="Event ",u+=l.format(" >2")(h)+" ",u+=(c+"             ").slice(0,r+1)+" ",u+=l.format(" >5")(t-e)+" ","initEnd"!=c&&(u+=l.format(" >5")(t-n.start[i])),"dataProcessEnd"==c&&(u+=" prepare                 "+l.format(" >5")(t-n.layoutEnd[i])),"renderEnd"==c&&(u+=" transition start margin "+l.format(" >5")(s._transition.delay()-(t-n.renderStart[i])),a=s._transition.delay(),o=s._transition.duration()),"transitionStart"==c){var d=t-n.renderStart[i];u+=" transition delay        "+l.format(" >5")(t-n.renderStart[i]),u+=" expected "+l.format(" >5")(a),u+=" diff "+l.format(" >5")(d-a)}if("transitionEnd"==c){var f=t-n.transitionStart[i];u+=" transition duration     "+l.format(" >5")(f),u+=" expected "+l.format(" >5")(o),u+=" diff "+l.format(" >5")(f-o)}console.log(u),e=t}:null)}return this}},e.selection.prototype.graphviz=function(){return new b(this)},e.selection.prototype.selectWithoutDataPropagation=function(t){return e.select(this.node().querySelector(t))},t.graphviz=E,Object.defineProperty(t,"__esModule",{value:!0})});